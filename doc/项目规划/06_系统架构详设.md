# Aiden-Lite 系统架构详细设计

## 一、核心架构概览

### 系统三层架构 (当前已完成部分)

```
┌─────────────────────────────────────────────────────────────┐
│                 用户交互层 (Web UI)                         │
│  ┌──────────┬──────────┬──────────┬──────────┬──────────┐   │
│  │  浏览器  │  视频流  │  实时日志│  暗色主题│  Favicon │   │
│  └──────────┴──────────┴──────────┴──────────┴──────────┘   │
└─────────────────────────────────────────────────────────────┘
           ▲                    ▲                    ▲
           │                    │                    │
┌─────────────────────────────────────────────────────────────┐
│              业务逻辑层 (FastAPI + Core)                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 视频流处理   │  │ 人脸识别     │  │ 视觉增强     │      │
│  │ (Streaming)  │  │ (CompreFace) │  │ (Visualizer) │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 日志推送     │  │ 配置管理     │  │ 生命周期管理 │      │
│  │ (SSE)        │  │ (Dotenv)     │  │ (Lifespan)   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
           ▲                    ▲                    ▲
           │                    │                    │
┌─────────────────────────────────────────────────────────────┐
│                 基础服务层 (硬件与驱动)                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  摄像头      │  │  日志系统    │  │  异步事件    │      │
│  │  (OpenCV)    │  │  (Logging)   │  │  (Asyncio)   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

### 系统三层架构 (原始完整计划)

此架构为项目的最终形态，当前仅实现了 Web 监控与人脸识别部分，其余模块（如语音、日程、设备控制）将按计划逐步集成。

```
┌─────────────────────────────────────────────────────────────┐
│                 用户交互层 (I/O)                             │
│  ┌──────────┬──────────┬──────────┬──────────┬──────────┐   │
│  │  麦克风  │  摄像头  │  扬声器  │  MQTT    │  Web UI  │   │
│  └──────────┴──────────┴──────────┴──────────┴──────────┘   │
└─────────────────────────────────────────────────────────────┘
           ▲                    ▲                    ▲
           │                    │                    │
┌─────────────────────────────────────────────────────────────┐
│              业务逻辑层 (核心功能模块)                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 对话引擎     │  │ 人脸识别     │  │ 日程管理     │      │
│  │ (Dialogue)   │  │ (Recognition)│  │ (Schedule)   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 设备控制     │  │ 指令执行     │  │ 场景管理     │      │
│  │ (Device)     │  │ (Command)    │  │ (Scene)      │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
           ▲                    ▲                    ▲
           │                    │                    │
┌─────────────────────────────────────────────────────────────┐
│                 基础服务层 (支撑层)                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  数据库      │  │  消息队列    │  │  网络通信    │      │
│  │  (SQLite)    │  │  (Redis)     │  │  (HTTP/MQTT) │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  缓存系统    │  │  日志系统    │  │  配置管理    │      │
│  │  (Redis)     │  │  (Loguru)    │  │  (Pydantic)  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```


---

## 二、核心模块详细设计

### 2.1 AI 对话引擎模块 (DialogueEngine)

#### 模块组成
```python
DialogueEngine
├── ASRModule              # 语音识别
│   ├── audio_capture()    # 采集音频
│   ├── recognize_speech() # Whisper 识别
│   └── stream_asr()       # 流式识别
├── TTSModule              # 文字转语音
│   ├── synthesize()       # 生成语音
│   ├── play_audio()       # 播放音频
│   └── cache_audio()      # 缓存管理
├── NLUModule              # 自然语言理解
│   ├── extract_intent()   # 意图识别
│   ├── extract_entities() # 实体提取
│   └── classify_dialog()  # 对话分类
├── LLMClient              # 大模型接口
│   ├── call_llm()         # 调用 LLM
│   ├── stream_response()  # 流式响应
│   └── manage_tokens()    # Token 管理
├── MemoryManager          # 记忆系统
│   ├── store_memory()     # 存储记忆
│   ├── retrieve_memory()  # 检索记忆
│   └── update_memory()    # 更新记忆
├── ContextManager         # 上下文管理
│   ├── build_context()    # 构建上下文
│   ├── retrieve_context() # 检索相关信息
│   └── manage_window()    # 窗口管理
└── ConversationManager    # 对话管理
    ├── start_session()    # 开启会话
    ├── process_turn()     # 处理轮次
    └── end_session()      # 结束会话
```

#### 工作流程
```
用户语音 → 采集 → ASR 识别 → NLU 理解
    ↓
[检查是否为系统命令]
    ├─ 是 → 执行相应业务逻辑 (人脸、日程等) → 生成回复
    └─ 否 → 构建 LLM 提示词 + 检索记忆/上下文 → 调用 LLM → 获得回复
    ↓
TTS 转语音 → 播放扬声器 → 用户听到回复
```

### 2.2 人脸识别模块 (FaceRecognitionModule)

#### 模块组成
```python
FaceRecognitionModule
├── CameraModule           # 摄像头管理
│   ├── list_cameras()     # 列出可用摄像头
│   ├── connect_camera()   # 连接摄像头
│   ├── capture_frame()    # 捕获帧
│   └── release_camera()   # 释放资源
├── FaceDetector           # 人脸检测
│   ├── detect_faces()     # 检测人脸位置
│   ├── extract_landmarks()# 提取面部特征点
│   └── assess_quality()   # 评估质量 (清晰、角度、亮度)
├── FaceRecognizer         # 人脸识别
│   ├── encode_face()      # 生成人脸编码
│   ├── match_faces()      # 1:1 匹配
│   ├── search_faces()     # 1:N 搜索
│   └── compute_similarity()# 计算相似度
├── PersonDatabase         # 人员数据库
│   ├── add_person()       # 新增人员
│   ├── remove_person()    # 删除人员
│   ├── get_person()       # 查询人员信息
│   └── get_face_encodings()# 获取人脸编码
└── GreetingEngine         # 问候生成
    ├── generate_greeting()# 生成问候文本
    ├── call_llm_for_greeting()# 调用 LLM 优化
    └── play_greeting()    # 播放问候语音
```

#### 工作流程
```
实时摄像头 → 帧采集 → 人脸检测 → 人脸质量评估
    ↓
[检测到高质量人脸]
    ↓
人脸编码 → 与人脸库匹配 → 识别身份
    ↓
从数据库查询人员信息 → 生成个性化问候 → TTS 播放
```

### 2.3 日程管理模块 (ScheduleModule)

#### 模块组成
```python
ScheduleModule
├── ScheduleParser         # 日程解析
│   ├── extract_time()     # 提取时间实体
│   ├── extract_event()    # 提取事件信息
│   ├── normalize_time()   # 规范化时间 (明天 → 日期)
│   └── parse_recurrence() # 解析重复规则
├── ScheduleDB             # 日程数据库
│   ├── create_schedule()  # 创建日程
│   ├── update_schedule()  # 更新日程
│   ├── delete_schedule()  # 删除日程
│   ├── query_schedules()  # 查询日程
│   └── check_conflicts()  # 冲突检测
├── ScheduleReminder       # 提醒引擎
│   ├── check_reminders()  # 定时检查提醒
│   ├── trigger_reminder() # 触发提醒
│   ├── generate_content() # 生成提醒内容
│   └── log_reminder()     # 记录提醒
├── ScheduleOptimizer      # 智能规划
│   ├── analyze_schedule() # 分析日程
│   ├── optimize_route()   # 优化路线
│   └── suggest_optimization()# 提出建议
└── CalendarSync           # 日历同步 (可选)
    ├── export_ical()      # 导出 iCal
    └── import_ical()      # 导入 iCal
```

#### 工作流程
```
用户语音 "明天上午10点开会" → NLU 提取
    ↓
时间标准化: "明天上午10点" → "2025-01-08 10:00"
事件提取: "开会"
    ↓
存入数据库
    ↓
定时检查 (APScheduler) → 到达提醒时间 → 触发提醒
```

### 2.4 设备控制模块 (DeviceModule)

#### 模块组成
```python
DeviceModule
├── MQTTClient             # MQTT 通信
│   ├── connect()          # 连接 Broker
│   ├── subscribe()        # 订阅主题
│   ├── publish()          # 发布消息
│   └── disconnect()       # 断开连接
├── DeviceRegistry         # 设备注册表
│   ├── register_device()  # 注册设备
│   ├── unregister_device()# 注销设备
│   ├── list_devices()     # 列出设备
│   └── get_device()       # 获取设备
├── CommandExecutor        # 指令执行
│   ├── turn_on()          # 打开 (灯、设备)
│   ├── turn_off()         # 关闭
│   ├── set_brightness()   # 调节亮度
│   ├── set_temperature()  # 调节温度
│   └── execute_custom()   # 执行自定义指令
├── SceneManager           # 场景管理
│   ├── create_scene()     # 创建场景
│   ├── execute_scene()    # 执行场景
│   ├── list_scenes()      # 列出场景
│   └── update_scene()     # 更新场景
└── MiHomeAPI              # 米家集成
    ├── authenticate()     # 授权认证
    ├── get_devices()      # 获取设备列表
    ├── control_device()   # 控制设备
    ├── get_rooms()        # 获取房间
    └── execute_scene()    # 执行米家场景
```

#### 工作流程
```
用户语音 "打开客厅的灯" → NLU 识别
    ↓
设备查询: 找到 "客厅灯" → MQTT 发送 ON 指令
    ↓
设备执行 → 状态更新 → 反馈用户
```

### 2.5 数据库模型设计

#### 核心表结构

**users** - 用户信息表
```python
class User(Base):
    id: int                 # 主键
    name: str              # 姓名
    relation: str          # 关系 (主人/父母/访客等)
    occupation: str        # 职业
    phone: str             # 电话
    address: str           # 地址
    created_at: datetime   # 创建时间
```

**face_encodings** - 人脸编码表
```python
class FaceEncoding(Base):
    id: int
    user_id: int (FK)
    encoding: bytes        # 128D 人脸特征向量
    quality_score: float   # 质量评分
    created_at: datetime
```

**conversations** - 对话记录表
```python
class Conversation(Base):
    id: int
    user_id: int (FK)
    timestamp: datetime
    user_message: str      # 用户输入
    assistant_response: str# AI 回复
    tokens_used: int       # Token 使用量
```

**schedules** - 日程表
```python
class Schedule(Base):
    id: int
    user_id: int (FK)
    title: str             # 日程标题
    description: str       # 描述
    start_time: datetime   # 开始时间
    end_time: datetime     # 结束时间
    location: str          # 地点
    participants: str      # 参与人
    reminders: list        # 提醒时间 [1小时前, 准时]
    recurrence: str        # 重复规则 (可选)
```

**devices** - 设备表
```python
class Device(Base):
    id: int
    name: str              # 设备名称
    type: str              # 类型 (灯/温度计/开关等)
    protocol: str          # 协议 (MQTT/HTTP/CoAP)
    connection_info: dict  # 连接信息
    status: str            # 状态 (on/off)
    location: str          # 位置 (客厅/卧室等)
```

**scenes** - 场景表
```python
class Scene(Base):
    id: int
    name: str              # 场景名称
    description: str       # 描述
    trigger_condition: str # 触发条件
    actions: list          # 执行的指令列表
    enabled: bool          # 是否启用
```

**memories** - 记忆表
```python
class Memory(Base):
    id: int
    user_id: int (FK)
    content: str           # 记忆内容
    importance: int        # 重要度 (1-10)
    created_at: datetime
    last_accessed: datetime
    access_count: int      # 访问次数
```

---

## 三、关键算法与流程

### 3.1 对话流程 (Complete Dialogue Flow)

```
START
  ↓
WAKEUP_DETECTION (监听唤醒词)
  ├─ 未检测到 → 继续监听
  └─ 检测到 → 进入识别模式
  ↓
AUDIO_CAPTURE (采集音频)
  ├─ 超时未输入 → 返回待机
  └─ 采集完成 → 进行识别
  ↓
ASR_RECOGNITION (语音转文字)
  ├─ 识别失败 → 提示重试
  └─ 识别成功 → 继续处理
  ↓
NLU_UNDERSTANDING (意图理解)
  ├─ Intent = "system_command"
  │  ├─ "打开灯" → 调用 DeviceModule
  │  ├─ "查询日程" → 调用 ScheduleModule
  │  ├─ "创建日程" → 调用 ScheduleModule
  │  └─ "控制设备" → 调用 DeviceModule
  │
  └─ Intent = "general_dialogue"
     ↓
RETRIEVE_CONTEXT (检索记忆/上下文)
  ├─ 获取对话历史
  ├─ 获取长期记忆
  └─ 获取当前场景信息
  ↓
BUILD_PROMPT (构建提示词)
  ├─ 系统 Prompt (AI 角色)
  ├─ 上下文信息
  ├─ 用户消息
  └─ 历史对话
  ↓
CALL_LLM (调用大模型)
  ├─ 发送请求到 OpenAI/Claude
  ├─ 获取流式响应
  └─ 实时处理响应
  ↓
STORE_CONVERSATION (存储对话)
  ├─ 保存用户消息
  ├─ 保存 AI 回复
  └─ 计算 Token 使用量
  ↓
TTS_SYNTHESIS (文字转语音)
  ├─ 调用 edge-tts
  └─ 生成音频文件
  ↓
PLAYBACK_RESPONSE (播放回复)
  ├─ 通过扬声器播放
  └─ 等待下一个输入
  ↓
LOOP (继续对话)
  ├─ 超时 → 返回待机
  └─ 新输入 → 回到 AUDIO_CAPTURE
```

### 3.2 人脸识别流程 (Face Recognition Pipeline)

```
START
  ↓
CAMERA_CAPTURE (摄像头采集 30fps)
  ├─ 采集失败 → 重试
  └─ 采集成功 → 处理帧
  ↓
FACE_DETECTION (人脸检测)
  ├─ 未检测到人脸 → 继续采集
  └─ 检测到人脸 → 质量评估
  ↓
QUALITY_ASSESSMENT (质量评估)
  ├─ 清晰度 > 阈值?
  ├─ 亮度正常?
  ├─ 人脸角度 < 30°?
  └─ 全部满足? → 编码人脸
  ├─ 不满足 → 继续采集
  
FACE_ENCODING (编码)
  ↓
FACE_MATCHING (与数据库匹配)
  ├─ 计算相似度 (余弦距离)
  ├─ 查找最相似的人脸
  └─ 相似度 > 阈值? (0.6)
     ├─ 是 → 识别成功
     └─ 否 → 识别失败 (未知人脸)
  ↓
DATABASE_LOOKUP (查询人员信息)
  ├─ 获取姓名
  ├─ 获取关系
  ├─ 获取职业
  └─ 获取其他信息
  ↓
CHECK_SCHEDULE (查询日程)
  ├─ 获取当前时间
  ├─ 查询本时段日程
  └─ 有日程? → 准备提醒
  ↓
GENERATE_GREETING (生成问候)
  ├─ 基于关系的模板
  ├─ 调用 LLM 优化文案
  └─ 生成自然问候
  ↓
TTS_AND_PLAYBACK (语音播放)
  ├─ "你好，小王，欢迎回家"
  ├─ "你还有一个10点的会议要提醒"
  └─ 播放完毕
  ↓
RECOGNITION_COOLDOWN (冷却期)
  ├─ 30 秒内同人脸不再识别 (防止重复)
  └─ 回到采集
```

### 3.3 日程提醒流程 (Schedule Reminder Pipeline)

```
START (后台定时任务)
  ↓
SCHEDULE_CHECK (每分钟检查一次)
  ├─ 查询所有待提醒日程
  ├─ 检查是否到达提醒时间
  └─ 有待提醒? → 执行提醒
  ├─ 无 → 继续等待
  ↓
FACE_DETECTION (检测当前用户)
  ├─ 检测到人脸? 
  │  ├─ 是 → 立即提醒
  │  └─ 否 → 延迟提醒
  └─ 无人脸 → 安排后续检查
  ↓
REMINDER_GENERATION (生成提醒内容)
  ├─ 日程标题: "开会"
  ├─ 时间: "10:00"
  ├─ 地点: "会议室 A"
  ├─ 构建自然文案
  └─ "提醒你，现在是 9:30，你有一个开会，在会议室 A，10 点开始"
  ↓
TEXT_TO_SPEECH (转语音)
  └─ 生成音频
  ↓
PLAYBACK (播放提醒)
  ├─ 获取用户的扬声器
  ├─ 播放提醒语音
  └─ 标记为已提醒
  ↓
LOG_REMINDER (记录提醒)
  ├─ 保存提醒时间
  ├─ 保存提醒方式
  └─ 保存用户反应 (如果有)
```

---

## 四、扩展接口设计

### 4.1 MCP (Model Context Protocol) 接口

```python
class MCPTools:
    """MCP 工具定义"""
    
    # 数据库查询工具
    async def query_database(query: str, params: dict) -> dict
    
    # 设备控制工具
    async def control_device(device_id: str, action: str) -> dict
    
    # 日程操作工具
    async def manage_schedule(action: str, data: dict) -> dict
    
    # 人员信息查询
    async def query_person(person_id: str) -> dict
    
    # 自定义指令执行
    async def execute_command(command: str, args: dict) -> dict
```

### 4.2 第三方集成接口

```
# 小爱同学接口
async def call_xiaoai(requirement: str) -> str

# 摄像头流接口
async def get_camera_stream(camera_id: str) -> Stream

# Web API 接口
FastAPI 应用提供的 RESTful 端点
```

---

## 五、部署拓扑

### 5.1 单机部署
```
[用户设备] ← USB/蓝牙 ← [本地 PC (Aiden-Lite)]
            麦克风
            摄像头
            扬声器
                    ↓ (HTTP/HTTPS)
                [云端 LLM 服务]
                    ↓
                [MQTT Broker] ← [智能设备]
```

### 5.2 分布式部署 (可选)
```
[摄像头 1]   [摄像头 2]   [MQTT 网关]
    ↓            ↓            ↓
    └────────[本地 Aiden-Lite]────────┐
                    ↓ (HTTPS)          │
        [云端 LLM 服务]                │
                    ↓                  │
[本地 MQTT Broker] ← MQTT ← [Smart Devices]
```

---

## 六、配置管理

### 6.1 配置优先级 (从高到低)
1. 命令行参数
2. 环境变量 (.env)
3. 配置文件 (config/app.yaml)
4. 默认值 (代码中)

### 6.2 关键配置项
```yaml
# app.yaml

# LLM 配置
llm:
  provider: "openai"
  model: "gpt-4"
  api_key: ${OPENAI_API_KEY}
  temperature: 0.7
  max_tokens: 1000

# 语音配置
speech:
  asr_model: "base"  # whisper 模型
  tts_provider: "edge"
  language: "zh-CN"

# 人脸识别
face:
  detection_model: "opencv"
  recognition_threshold: 0.6
  quality_threshold: 0.8

# 日程
schedule:
  reminder_advance_minutes: [60, 30, 0]
  timezone: "Asia/Shanghai"

# 设备
devices:
  mqtt_broker: "localhost:1883"
  mqtt_tls_enabled: false
```

---

## 七、错误处理与恢复

### 7.1 错误分类
```
系统错误 (Critical)
├─ 数据库连接失败
├─ 配置文件缺失
└─ 硬件资源耗尽

功能错误 (High)
├─ LLM API 超时
├─ 语音识别失败
├─ 人脸识别失败
└─ 设备连接失败

警告 (Medium)
├─ 响应延迟过高
├─ Token 使用过多
└─ 缓存未命中
```

### 7.2 恢复策略
```
LLM API 失败 → 使用本地模型备选或缓存回复
麦克风采集失败 → 提示用户重试
摄像头无法连接 → 禁用人脸功能，继续运行
MQTT 连接失败 → 队列指令，待连接恢复后重试
```

---

## 八、性能优化策略

### 8.1 推理加速
- 使用 GPU (CUDA/ROCm)
- ONNX Runtime 加速推理
- 模型量化 (INT8/FP16)
- 动态批处理

### 8.2 内存优化
- 编码缓存 (LRU Cache)
- 连接池复用
- 及时释放资源
- 内存分析与监控

### 8.3 并发优化
- 异步 I/O (asyncio)
- 线程池处理 CPU 密集任务
- 请求队列管理
- 速率限制 (Rate Limiting)

### 8.4 网络优化
- 连接复用
- 消息压缩
- 请求合并
- 本地缓存

