# Aiden-Lite 技术方案设计文档

## 一、整体架构

### 系统架构图
```
┌─────────────────────────────────────────────────────────────┐
│                    云端服务 (可选)                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ OpenAI API   │  │ Claude API   │  │ Gemini API   │      │
│  │ / 文心一言   │  │ / 讯飞星火   │  │ / 通义千问   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
           ▲                    ▲                    ▲
           │                    │                    │
┌─────────────────────────────────────────────────────────────┐
│              本地应用中枢 (Python)                           │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              AI 对话引擎层                            │   │
│  │  ┌──────────────┐ ┌──────────────┐ ┌───────────┐   │   │
│  │  │ 文字转语音   │ │ 语音转文字   │ │ 意图理解  │   │   │
│  │  │ (TTS)        │ │ (ASR)        │ │ (NLU)     │   │   │
│  │  └──────────────┘ └──────────────┘ └───────────┘   │   │
│  │  ┌──────────────────────────────────────────────┐   │   │
│  │  │ 对话管理 + 记忆系统 + 上下文管理             │   │   │
│  │  └──────────────────────────────────────────────┘   │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              业务功能模块层                           │   │
│  │  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐      │   │
│  │  │人脸识│ │日程管│ │设备控│ │情景  │ │指令  │      │   │
│  │  │别    │ │理    │ │制    │ │自动  │ │执行  │      │   │
│  │  └──────┘ └──────┘ └──────┘ └──────┘ └──────┘      │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              基础服务层                              │   │
│  │  ┌──────────────┐ ┌──────────────┐ ┌────────────┐  │   │
│  │  │ 本地数据库   │ │ 网络通信     │ │ 设备访问   │  │   │
│  │  │ (SQLite)     │ │ (MQTT/HTTP)  │ │ (Camera)   │  │   │
│  │  └──────────────┘ └──────────────┘ └────────────┘  │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
           ▲          ▲          ▲          ▲
           │          │          │          │
┌──────────┴──┬───────┴──┬───────┴──┬───────┴──────────┐
│   摄像头    │  扬声器  │  麦克风  │  MQTT/智能设备   │
│  (USB/IP)   │  (USB)   │  (USB)   │                  │
└─────────────┴──────────┴──────────┴──────────────────┘
```

## 二、技术栈选型

### 编程语言与框架

| 组件 | 主要选择 | 备选方案 | 理由 |
|------|--------|---------|------|
| **核心应用** | Python 3.10+ | Node.js | Python 生态完善，库众多 |
| **框架** | FastAPI | Flask | 异步支持强，适合实时应用 |
| **数据库** | SQLite + Redis | PostgreSQL | 本地部署，轻量化 |
| **消息队列** | RabbitMQ/Redis | Kafka | 模块间解耦 |
| **配置管理** | Pydantic | YAML | 类型安全，易验证 |

### 关键库清单

#### 1. 语音处理
- **ASR (语音转文字)**
  - `python-speech_recognition` - 离线识别基础
  - `faster-whisper` - OpenAI Whisper 本地推理 (推荐)
  - `ali-nls-python-sdk` - 阿里云实时语音识别
  - `iflytek-tts-sdk` - 讯飞实时语音识别

- **TTS (文字转语音)**
  - `pyttsx3` - 本地离线 TTS (质量一般)
  - `edge-tts` - 微软 Edge TTS (免费高质量)
  - `ali-sdk` - 阿里云语音合成 (支持方言)
  - `google-cloud-texttospeech` - Google TTS

#### 2. AI 和大模型交互
- `openai` - OpenAI API 调用
- `anthropic` - Claude API 调用
- `python-dotenv` - 环境变量管理
- `langchain` - LLM 应用框架 (支持记忆、链路)
- `llama-index` - 向量化存储和检索
- `tiktoken` - Token 计算

#### 3. 人脸识别
- `face_recognition` - 基于深度学习的识别 (推荐)
- `opencv-python` - 视频处理
- `mediapipe` - Google 的轻量级检测库
- `insightface` - 人脸识别工具包

#### 4. 摄像头/图像处理
- `opencv-python` - 摄像头驱动、图像处理
- `pillow` - 图像处理
- `imutils` - OpenCV 工具函数

#### 5. 网络通信
- `paho-mqtt` - MQTT 协议客户端
- `requests` - HTTP 请求
- `aiohttp` - 异步 HTTP
- `websocket-client` - WebSocket 连接

#### 6. 数据存储
- `sqlalchemy` - ORM 框架
- `sqlite3` - 内置数据库驱动
- `redis` - 缓存与队列
- `peewee` - 轻量级 ORM (可选)

#### 7. 日程管理
- `python-dateutil` - 日期时间处理
- `pytz` - 时区处理
- `schedule` - 任务调度
- `APScheduler` - 高级任务调度

#### 8. 日志与监控
- `loguru` - 强大的日志库
- `python-json-logger` - JSON 日志
- `sentry-sdk` - 错误追踪

#### 9. 测试
- `pytest` - 测试框架
- `pytest-asyncio` - 异步测试
- `mock` - 模拟库

### 云服务与第三方 API

| 功能 | 推荐服务商 | 备选 | 关键特性 |
|------|-----------|-----|---------|
| **大模型 API** | OpenAI (GPT-4) | 文心一言/Claude/通义千问 | 精度高、多模态 |
| **语音识别 ASR** | 讯飞/阿里云 | Google Speech | 中文支持好 |
| **文字转语音 TTS** | Edge-TTS (免费) | 阿里云/讯飞/腾讯云 | 自然度高 |
| **人脸识别** | 本地 face_recognition | 百度/阿里云 API | 隐私安全 |
| **米家生态** | 小米开放平台 API | - | 官方支持 |
| **mqtt broker** | 本地 Mosquitto | 云端 EMQ | 隐私安全 |

## 三、模块设计

### 3.1 AI 对话引擎模块

```
DialogueEngine
├── ASRModule (语音识别)
├── TTSModule (文本转语音)
├── NLUModule (自然语言理解)
├── LLMClient (大模型交互)
├── MemoryManager (记忆管理)
├── ContextManager (上下文管理)
└── ConversationManager (对话管理)
```

**关键流程**：
1. 麦克风采集音频
2. ASR 转录为文本
3. NLU 提取意图和实体
4. 触发对应业务逻辑或调用 LLM
5. LLM 根据上下文/记忆生成回复
6. TTS 转语音
7. 扬声器播放

### 3.2 人脸识别模块

```
FaceRecognitionModule
├── CameraCapture (摄像头采集)
├── FaceDetector (人脸检测)
├── FaceRecognizer (人脸识别)
├── PersonDatabase (人员数据库)
└── GreetingEngine (个性化问候)
```

**关键流程**：
1. 摄像头实时采集
2. 人脸检测（人脸存在性判断）
3. 人脸识别（身份识别）
4. 从 DB 查询身份信息
5. 生成个性化问候

### 3.3 日程管理模块

```
ScheduleModule
├── ScheduleParser (日程解析)
├── ScheduleDB (日程数据库)
├── ScheduleReminder (提醒引擎)
└── ScheduleOptimizer (智能规划)
```

**关键流程**：
1. 用户语音输入："明天上午10点开会"
2. NLU 提取：时间、事件、参与人
3. 存入 DB
4. 定时检查：摄像头识别 + 时间匹配 → 触发提醒

### 3.4 设备控制模块

```
DeviceControlModule
├── MQTTClient (MQTT 通信)
├── MiHomeAPI (米家集成)
├── CommandExecutor (指令执行)
├── SceneManager (场景管理)
├── DeviceRegistry (设备注册表)
└── StateManager (设备状态管理)
```

**支持的协议**：
- MQTT: 通用协议
- CoAP: 轻量级协议
- HTTP/REST: 万能方案
- 米家专有协议: 官方 SDK

### 3.5 数据库设计

**用户信息表**
```sql
users (
  id, name, relation, occupation, 
  face_encoding, phone, address, ...
)
```

**日程表**
```sql
schedules (
  id, user_id, title, description, 
  start_time, end_time, 
  reminder_time, location, ...
)
```

**对话记录表**
```sql
conversations (
  id, user_id, timestamp, 
  user_message, assistant_response, ...
)
```

**设备表**
```sql
devices (
  id, name, type, protocol, 
  connection_info, status, ...
)
```

**场景表**
```sql
scenes (
  id, name, description, trigger_condition,
  actions, enabled, ...
)
```

## 四、部署方案

### 4.1 开发环境
- **OS**: Windows 11/macOS/Linux
- **Python**: 3.10+
- **IDE**: VS Code + Python 扩展
- **虚拟环境**: venv / conda

### 4.2 运行环境
- **OS**: Windows 11/Linux (推荐)
- **硬件**: 
  - CPU: Intel i5+ / AMD Ryzen 5+
  - RAM: 8GB+ (推荐 16GB)
  - 存储: 50GB+
  - GPU: 可选 (NVIDIA RTX 2070+ 加速)

### 4.3 依赖安装
```bash
pip install fastapi uvicorn
pip install faster-whisper edge-tts
pip install face_recognition opencv-python
pip install openai langchain
pip install paho-mqtt
pip install sqlalchemy
```

## 五、安全与隐私

1. **本地优先**：优先使用本地推理，减少云传输
2. **数据加密**：敏感数据本地加密存储 (AES)
3. **通信加密**：MQTT 使用 TLS，HTTP 使用 HTTPS
4. **API Key 管理**：使用环境变量或密钥管理器
5. **权限控制**：摄像头、麦克风访问需显式授权

## 六、性能优化

1. **异步处理**：使用 asyncio 处理 I/O 密集操作
2. **缓存**：使用 Redis 缓存用户信息、日程等
3. **模型优化**：
   - 使用 ONNX 格式模型加速推理
   - 量化模型减小内存占用
4. **并发处理**：使用线程池处理多个请求
5. **资源管理**：及时释放摄像头、数据库连接

## 七、扩展性设计

1. **MCP 接口**：标准化工具调用
2. **插件系统**：支持第三方功能扩展
3. **配置驱动**：通过 YAML/JSON 配置行为
4. **模块解耦**：消息队列连接各模块
5. **API 网关**：统一的外部接口

